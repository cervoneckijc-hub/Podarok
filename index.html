<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤–∞ –ö—ñ–º–Ω–∞—Ç–∞ | Gift Room</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Minimalist Icons/Font Awesome for utility -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom Styles for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --primary-color: #FF6B6B; /* Coral/Warm Red Accent */
            --secondary-color: #4ECDC4; /* Teal Accent */
            --background-color: #F8F9FB;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            min-height: 100vh;
        }

        /* Styling for the circular gift cards */
        .gift-circle {
            width: 128px;
            height: 128px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--background-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-out;
            border: 4px solid transparent; /* Base border for hover effect */
            font-size: 3rem;
        }

        .gift-card-wrapper:hover .gift-circle {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            border: 4px solid var(--primary-color);
        }

        /* Status Colors */
        .status-available { background-color: #D1FAE5; color: #059669; } /* Green */
        .status-reserved { background-color: #FEEBC3; color: #D69E2E; } /* Orange */
        .status-bought { background-color: #E2E8F0; color: #475569; } /* Gray */

        /* Custom scrollbar for better aesthetics */
        .overflow-y-auto::-webkit-scrollbar { width: 6px; }
        .overflow-y-auto::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .overflow-y-auto::-webkit-scrollbar-track { background: var(--background-color); }
    </style>
</head>
<body class="antialiased">

    <!-- Global Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-50/70 backdrop-blur-sm z-[100] flex items-center justify-center transition-opacity duration-300">
        <div class="text-xl font-semibold text-gray-700 flex flex-col items-center">
            <i class="fas fa-gift animate-bounce text-4xl text-rose-500 mb-4"></i>
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- Header (Nav) -->
        <header class="flex justify-between items-center py-4 mb-8">
            <a href="#home" class="flex items-center space-x-2 text-2xl font-bold text-gray-900">
                <i class="fas fa-gift text-rose-500"></i>
                <span class="hidden sm:inline">–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤–∞ –ö—ñ–º–Ω–∞—Ç–∞</span>
                <span class="sm:hidden">–ö—ñ–º–Ω–∞—Ç–∞</span>
            </a>
            <div id="authStatus" class="text-sm text-gray-500"></div>
        </header>

        <!-- Main Content View (Router Target) -->
        <main id="content" class="min-h-[70vh]"></main>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- Modal Container -->
    <div id="modalContainer" class="fixed inset-0 z-40 hidden items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4">
        <div id="modalContent" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0">
            <!-- Modal content will be injected here -->
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 py-4 border-t border-gray-200 text-center text-sm text-gray-500">
        &copy; <span id="currentYear"></span> –ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤–∞ –ö—ñ–º–Ω–∞—Ç–∞. –í—Å—ñ –ø—Ä–∞–≤–∞ –∑–∞—Ö–∏—â–µ–Ω—ñ.
        <br>
        <span class="text-xs">ID –î–æ–¥–∞—Ç–∫—É: <span id="appIdDisplay" class="font-mono"></span></span>
    </footer>

    <!-- Firebase SDK Imports (MUST be defined before the main script execution) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================
        // 1. GLOBAL VARIABLES & UTILITIES
        // ====================================================================

        const apiKey = ""; // Leave as-is
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('Debug');
        let app, db, auth;
        let userId = null;
        let userName = null;
        let currentRoomId = null;
        let currentRoomData = null;
        let unsubscribeRoom = null; // for onSnapshot cleanup
        let isAuthReady = false;

        const ROOMS_COLLECTION = `artifacts/${appId}/public/data/rooms`;
        const PAGE_CONTAINER = document.getElementById('content');
        const LOADING_OVERLAY = document.getElementById('loadingOverlay');
        const MODAL_CONTAINER = document.getElementById('modalContainer');
        const MODAL_CONTENT = document.getElementById('modalContent');

        const DEFAULT_ROOM_ID = 'test';
        const GIFT_ICONS = {
            '–¢–µ—Ö–Ω—ñ–∫–∞': 'üíª',
            '–ö–Ω–∏–≥–∏': 'üìö',
            '–î–æ—Å–≤—ñ–¥': 'üé´',
            '–û–¥—è–≥': 'üëï',
            '–Ü–Ω—à–µ': 'üéÅ'
        };

        /** Shows a toast notification */
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const color = type === 'success' ? 'bg-teal-500' : 'bg-rose-500';
            const icon = type === 'success' ? '<i class="fas fa-check-circle mr-2"></i>' : '<i class="fas fa-exclamation-circle mr-2"></i>';

            const toast = document.createElement('div');
            toast.className = `p-4 rounded-lg shadow-xl text-white ${color} flex items-center transform translate-x-full transition-transform duration-300`;
            toast.innerHTML = `${icon}${message}`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 50);

            setTimeout(() => {
                toast.classList.add('translate-x-full');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3500);
        }

        /** Shows a custom modal */
        function showModal(content, onConfirm = null) {
            MODAL_CONTENT.innerHTML = content;
            MODAL_CONTAINER.classList.remove('hidden');
            MODAL_CONTAINER.classList.add('flex');
            setTimeout(() => {
                MODAL_CONTENT.classList.remove('scale-95', 'opacity-0');
                MODAL_CONTENT.classList.add('scale-100', 'opacity-100');
            }, 10);

            const confirmBtn = MODAL_CONTENT.querySelector('#modalConfirm');
            if (confirmBtn && onConfirm) {
                confirmBtn.onclick = () => {
                    onConfirm();
                    closeModal();
                };
            }
        }

        /** Hides the custom modal */
        function closeModal() {
            MODAL_CONTENT.classList.remove('scale-100', 'opacity-100');
            MODAL_CONTENT.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                MODAL_CONTAINER.classList.remove('flex');
                MODAL_CONTAINER.classList.add('hidden');
            }, 300);
        }

        /** Hides the loading overlay */
        function hideLoading() {
            LOADING_OVERLAY.style.opacity = '0';
            setTimeout(() => {
                LOADING_OVERLAY.style.display = 'none';
            }, 300);
        }
        
        // ====================================================================
        // 2. FIREBASE INITIALIZATION & AUTH
        // ====================================================================

        async function initFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Cannot initialize Firestore.");
                document.getElementById('authStatus').textContent = "–ü–æ–º–∏–ª–∫–∞: –ù–µ–º–∞—î –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó Firebase.";
                return;
            }
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('authStatus').innerHTML = `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: <span class="font-mono text-gray-800">${userId.substring(0, 8)}...</span>`;
                    isAuthReady = true;
                } else {
                    // Initial sign-in attempt
                    await authenticateUser();
                }
                // Once authenticated (or anonymously signed in), proceed
                if (isAuthReady) {
                    await ensureDefaultRoomExists();
                    handleRouteChange();
                }
            });
        }

        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó:", error);
                document.getElementById('authStatus').textContent = "–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó!";
            }
        }

        // ====================================================================
        // 3. CORE FIREBASE LOGIC
        // ====================================================================

        async function ensureDefaultRoomExists() {
            if (!db || !userId) return;

            const roomDocRef = doc(db, ROOMS_COLLECTION, DEFAULT_ROOM_ID);
            const roomDoc = await getDoc(roomDocRef);

            if (!roomDoc.exists()) {
                console.log(`–ö—ñ–º–Ω–∞—Ç–∞ '${DEFAULT_ROOM_ID}' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞. –°—Ç–≤–æ—Ä—é—î–º–æ...`);
                
                const defaultRoom = {
                    name: "–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è (–¢–µ—Å—Ç)",
                    ownerId: userId,
                    ownerName: "–¢–µ—Å—Ç–æ–≤–∏–π –í–ª–∞—Å–Ω–∏–∫",
                    guestCount: 5,
                    eventDate: new Date().toISOString().substring(0, 10),
                    hideReserved: false, // Default setting
                    gifts: [
                        { id: crypto.randomUUID(), name: "–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –Ω–∞–≤—É—à–Ω–∏–∫–∏", price: 1500, description: "–Ø–∫—ñ—Å–Ω–∏–π –∑–≤—É–∫ —Ç–∞ —à—É–º–æ–∑–∞–≥–ª—É—à–µ–Ω–Ω—è.", link: "https://example.com/headphones", icon: GIFT_ICONS['–¢–µ—Ö–Ω—ñ–∫–∞'], category: '–¢–µ—Ö–Ω—ñ–∫–∞', type: 'electronic', status: 'available', reservedBy: null, userName: null },
                        { id: crypto.randomUUID(), name: "–ù–∞—Å—Ç—ñ–ª—å–Ω–∞ –≥—Ä–∞ (–Ω–æ–≤–∏–Ω–∫–∞)", price: 800, description: "–°—Ç—Ä–∞—Ç–µ–≥—ñ—á–Ω–∞ –≥—Ä–∞ –¥–ª—è –≤–µ—á—ñ—Ä–∫–∏.", link: "https://example.com/boardgame", icon: GIFT_ICONS['–î–æ—Å–≤—ñ–¥'], category: '–î–æ—Å–≤—ñ–¥', type: 'physical', status: 'available', reservedBy: null, userName: null },
                        { id: crypto.randomUUID(), name: "–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –≤ –∫–Ω–∏–≥–∞—Ä–Ω—é", price: 500, description: "–ù–∞ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –∞–±–æ –ø–∞–ø–µ—Ä–æ–≤—ñ –∫–Ω–∏–≥–∏.", link: "https://example.com/bookstore", icon: GIFT_ICONS['–ö–Ω–∏–≥–∏'], category: '–ö–Ω–∏–≥–∏', type: 'electronic', status: 'available', reservedBy: null, userName: null },
                        { id: crypto.randomUUID(), name: "–°—Ç–∏–ª—å–Ω–∏–π —Å–≤–µ—Ç—Ä", price: 1200, description: "–†–æ–∑–º—ñ—Ä L, –∫–æ–ª—ñ—Ä —Å—ñ—Ä–∏–π.", link: "https://example.com/sweater", icon: GIFT_ICONS['–û–¥—è–≥'], category: '–û–¥—è–≥', type: 'physical', status: 'available', reservedBy: null, userName: null },
                        { id: crypto.randomUUID(), name: "–ï–∫–æ-–ø–ª—è—à–∫–∞ –¥–ª—è –≤–æ–¥–∏", price: 400, description: "–î–ª—è —Ç—Ä–µ–Ω—É–≤–∞–Ω—å.", link: "", icon: GIFT_ICONS['–Ü–Ω—à–µ'], category: '–Ü–Ω—à–µ', type: 'physical', status: 'reserved', reservedBy: 'initial_reservation', userName: '–ê–Ω–æ–Ω—ñ–º (–¢–µ—Å—Ç)' },
                    ]
                };

                try {
                    await setDoc(roomDocRef, defaultRoom);
                    showToast(`–¢–µ—Å—Ç–æ–≤—É –∫—ñ–º–Ω–∞—Ç—É (${DEFAULT_ROOM_ID}) —Å—Ç–≤–æ—Ä–µ–Ω–æ!`);
                } catch (e) {
                    console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ç–µ—Å—Ç–æ–≤–æ—ó –∫—ñ–º–Ω–∞—Ç–∏:", e);
                    showToast("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ç–µ—Å—Ç–æ–≤–æ—ó –∫—ñ–º–Ω–∞—Ç–∏.", 'error');
                }
            }
        }

        /** Handles saving a new room or updating an existing one */
        async function saveRoom(data, roomId = null) {
            try {
                const roomData = {
                    ...data,
                    ownerId: userId,
                    ownerName: data.ownerName || '–í–ª–∞—Å–Ω–∏–∫',
                };

                if (roomId) {
                    // Check if a room with this ID already exists
                    const existingDoc = await getDoc(doc(db, ROOMS_COLLECTION, roomId));
                    if (existingDoc.exists()) {
                        showToast(`–ö—ñ–º–Ω–∞—Ç–∞ –∑ –∫–æ–¥–æ–º "${roomId}" –≤–∂–µ —ñ—Å–Ω—É—î. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –∫–æ–¥.`, 'error');
                        return null;
                    }
                    await setDoc(doc(db, ROOMS_COLLECTION, roomId), roomData);
                } else {
                    // Auto-generate ID if needed, but for this app, we need a clean code, so we use the provided one.
                    // For now, only the explicit ID creation is used (like 'test' or user input).
                }

                showToast(`–ö—ñ–º–Ω–∞—Ç—É "${data.name}" —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!`);
                return roomId;

            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –∫—ñ–º–Ω–∞—Ç–∏:", e);
                showToast("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –∫—ñ–º–Ω–∞—Ç–∏.", 'error');
                return null;
            }
        }

        /** Real-time room data listener */
        function subscribeToRoom(roomId) {
            if (!db) return;

            if (unsubscribeRoom) {
                unsubscribeRoom(); // Clean up previous listener
            }

            const roomDocRef = doc(db, ROOMS_COLLECTION, roomId);
            unsubscribeRoom = onSnapshot(roomDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    currentRoomData = docSnapshot.data();
                    renderRoomView(roomId, currentRoomData);
                } else {
                    currentRoomId = null;
                    currentRoomData = null;
                    showToast("–ö—ñ–º–Ω–∞—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.", 'error');
                    window.location.hash = 'home';
                }
            }, (error) => {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –¥–∞–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç–∏:", error);
                showToast("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –∫—ñ–º–Ω–∞—Ç–∏.", 'error');
            });
        }

        /** Handles reservation/unreservation/buy updates */
        async function updateGiftStatus(giftId, newStatus, userNameInput = '–ê–Ω–æ–Ω—ñ–º') {
            if (!db || !currentRoomId || !userId) return;

            const roomDocRef = doc(db, ROOMS_COLLECTION, currentRoomId);
            const giftIndex = currentRoomData.gifts.findIndex(g => g.id === giftId);

            if (giftIndex === -1) {
                showToast("–ü–æ–¥–∞—Ä—É–Ω–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.", 'error');
                return;
            }

            const updatedGifts = [...currentRoomData.gifts];
            const gift = updatedGifts[giftIndex];

            try {
                let updatePayload = {};

                if (newStatus === 'reserved') {
                    if (gift.status === 'reserved') {
                         showToast("–¶–µ–π –ø–æ–¥–∞—Ä—É–Ω–æ–∫ –≤–∂–µ –∑–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ.", 'error');
                         return;
                    }
                    updatePayload = {
                        status: 'reserved',
                        reservedBy: userId,
                        userName: userNameInput || '–ê–Ω–æ–Ω—ñ–º',
                        boughtBy: null,
                    };
                    showToast(`–í–∏ –∑–∞–±—Ä–æ–Ω—é–≤–∞–ª–∏ "${gift.name}"!`);
                } else if (newStatus === 'available') {
                    if (gift.reservedBy !== userId) {
                        showToast("–í–∏ –Ω–µ –º–æ–∂–µ—Ç–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ —á—É–∂—É –±—Ä–æ–Ω—å.", 'error');
                        return;
                    }
                    updatePayload = {
                        status: 'available',
                        reservedBy: null,
                        userName: null,
                        boughtBy: null,
                    };
                    showToast(`–ë—Ä–æ–Ω—å –Ω–∞ "${gift.name}" —Å–∫–∞—Å–æ–≤–∞–Ω–æ.`);
                } else if (newStatus === 'bought') {
                    if (gift.status === 'bought' && gift.boughtBy) {
                        showToast("–¶–µ–π –ø–æ–¥–∞—Ä—É–Ω–æ–∫ –≤–∂–µ –∫—É–ø–ª–µ–Ω–æ.", 'error');
                        return;
                    }
                    // Allow marking as bought only if reserved by current user or if owner
                    if (gift.reservedBy !== userId && currentRoomData.ownerId !== userId) {
                        showToast("–ü–æ–¥–∞—Ä—É–Ω–æ–∫ –º–æ–∂–µ –≤—ñ–¥–º—ñ—Ç–∏—Ç–∏ —è–∫ '–ö—É–ø–ª–µ–Ω–æ' –ª–∏—à–µ —Ç–æ–π, —Ö—Ç–æ –π–æ–≥–æ –∑–∞–±—Ä–æ–Ω—é–≤–∞–≤, –∞–±–æ –í–ª–∞—Å–Ω–∏–∫.", 'error');
                        return;
                    }

                    updatePayload = {
                        status: 'bought',
                        boughtBy: userId,
                        userName: userNameInput || '–ê–Ω–æ–Ω—ñ–º',
                        reservedBy: userId, // Keep reserved info for context
                    };
                    showToast(`–ü–æ–¥–∞—Ä—É–Ω–æ–∫ "${gift.name}" —É—Å–ø—ñ—à–Ω–æ –∫—É–ø–ª–µ–Ω–æ!`);
                }

                updatedGifts[giftIndex] = { ...gift, ...updatePayload };

                await updateDoc(roomDocRef, { gifts: updatedGifts });

            } catch (error) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø–æ–¥–∞—Ä—É–Ω–∫–∞:", error);
                showToast("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É.", 'error');
            }
        }


        // ====================================================================
        // 4. ROUTING & RENDERING
        // ====================================================================

        /** Renders the Home/Landing page */
        function renderHome() {
            PAGE_CONTAINER.innerHTML = `
                <div class="text-center py-16 px-4">
                    <h1 class="text-5xl font-extrabold text-gray-900 mb-4 tracking-tight">
                        –û—Ä–≥–∞–Ω—ñ–∑—É–π—Ç–µ –ø–æ–¥–∞—Ä—É–Ω–∫–∏ –±–µ–∑ —Å—Ç—Ä–µ—Å—É.
                    </h1>
                    <p class="text-xl text-gray-600 mb-10">
                        –°–µ—Ä–≤—ñ—Å "–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤–∞ –ö—ñ–º–Ω–∞—Ç–∞" ‚Äî –ø—Ä–æ—Å—Ç–∏–π –≤–µ–±-–¥–æ–¥–∞—Ç–æ–∫, –¥–µ –¥—Ä—É–∑—ñ —Ç–∞ —Ä–æ–¥–∏–Ω–∞ –æ–±–∏—Ä–∞—é—Ç—å, –±—Ä–æ–Ω—é—é—Ç—å —Ç–∞ –∫—É–ø—É—é—Ç—å –ø–æ–¥–∞—Ä—É–Ω–∫–∏ –¥–ª—è –æ—Å–æ–±–ª–∏–≤–æ—ó –ø–æ–¥—ñ—ó.
                    </p>

                    <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6">
                        <a href="#create" class="px-8 py-4 bg-rose-500 text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-rose-600 transition-all transform hover:scale-[1.02] shadow-rose-500/40">
                            <i class="fas fa-plus-circle mr-2"></i> –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É
                        </a>
                        <button onclick="showJoinModal()" class="px-8 py-4 bg-white text-gray-800 text-lg font-semibold rounded-xl border border-gray-300 shadow-md hover:shadow-lg transition-all transform hover:scale-[1.02]">
                            <i class="fas fa-sign-in-alt mr-2"></i> –£–≤—ñ–π—Ç–∏ –≤ –∫—ñ–º–Ω–∞—Ç—É
                        </button>
                    </div>

                    <p class="mt-8 text-md text-gray-500">
                        –î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Å–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—è –∫–æ–¥–æ–º: <code class="font-mono text-rose-500">test</code>
                    </p>

                    <div class="mt-16 text-left max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?</h2>
                        <ul class="space-y-4 text-gray-600">
                            <li class="flex items-start">
                                <span class="text-rose-500 font-bold mr-3 text-xl">1.</span>
                                <div><strong class="text-gray-900">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è.</strong> –í–ª–∞—Å–Ω–∏–∫ –ø–æ–¥—ñ—ó —Å—Ç–≤–æ—Ä—é—î –∫—ñ–º–Ω–∞—Ç—É —Ç–∞ –¥–æ–¥–∞—î —Å–ø–∏—Å–æ–∫ –±–∞–∂–∞–Ω–∏—Ö –ø–æ–¥–∞—Ä—É–Ω–∫—ñ–≤.</div>
                            </li>
                            <li class="flex items-start">
                                <span class="text-rose-500 font-bold mr-3 text-xl">2.</span>
                                <div><strong class="text-gray-900">–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è.</strong> –î—ñ–ª–∏—Ç—å—Å—è —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º –∫–æ–¥–æ–º –∫—ñ–º–Ω–∞—Ç–∏ –∑ –≥–æ—Å—Ç—è–º–∏.</div>
                            </li>
                            <li class="flex items-start">
                                <span class="text-rose-500 font-bold mr-3 text-xl">3.</span>
                                <div><strong class="text-gray-900">–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è.</strong> –ì–æ—Å—Ç—ñ –≤–∏–±–∏—Ä–∞—é—Ç—å –ø–æ–¥–∞—Ä—É–Ω–æ–∫, –±—Ä–æ–Ω—é—é—Ç—å –π–æ–≥–æ (—â–æ–± —ñ–Ω—à—ñ –∑–Ω–∞–ª–∏, —â–æ –≤—ñ–Ω –∑–∞–π–Ω—è—Ç–∏–π) —ñ –∫—É–ø—É—é—Ç—å.</div>
                            </li>
                        </ul>
                    </div>

                </div>
            `;
            hideLoading();
        }

        /** Shows modal for joining a room */
        function showJoinModal() {
             const content = `
                <h3 class="text-2xl font-bold text-gray-800 mb-4">–£–≤—ñ–π—Ç–∏ –≤ –∫—ñ–º–Ω–∞—Ç—É</h3>
                <p class="text-gray-600 mb-4">–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏ —Ç–∞ –≤–∞—à–µ —ñ–º'—è.</p>
                <input type="text" id="roomCodeInput" placeholder="–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, test)" value="" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-rose-500 focus:border-rose-500">
                <input type="text" id="guestNameInput" placeholder="–í–∞—à–µ —ñ–º'—è (–¥–ª—è –±—Ä–æ–Ω—ñ, –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)" value="${userName || ''}" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                
                <div class="flex justify-end space-x-3">
                    <button onclick="closeModal()" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button id="modalConfirm" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition font-semibold">–£–≤—ñ–π—Ç–∏</button>
                </div>
            `;
            showModal(content, () => {
                const code = document.getElementById('roomCodeInput').value.trim().toLowerCase();
                const name = document.getElementById('guestNameInput').value.trim();
                if (code) {
                    if (name) userName = name;
                    window.location.hash = `room/${code}`;
                } else {
                    showToast("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏.", 'error');
                }
            });
        }

        /** Renders the Create Room form */
        function renderCreateRoom() {
            PAGE_CONTAINER.innerHTML = `
                <h1 class="text-4xl font-bold text-gray-800 mb-8">–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É –∫—ñ–º–Ω–∞—Ç—É</h1>
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg max-w-3xl mx-auto">
                    <form id="createRoomForm" class="space-y-6">
                        <label class="block">
                            <span class="text-gray-700 font-medium">–ù–∞–∑–≤–∞ –ø–æ–¥—ñ—ó (–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –Ü—Ä–∏) *</span>
                            <input type="text" id="roomName" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-rose-500 focus:ring-rose-500" placeholder="–û–±–æ–≤'—è–∑–∫–æ–≤–æ">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 font-medium">–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏ (–£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥: —ñ—Ä–∞2024) *</span>
                            <input type="text" id="roomIdInput" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-rose-500 focus:ring-rose-500" placeholder="–ö–æ–¥, —è–∫–∏–π –≥–æ—Å—Ç—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏–º—É—Ç—å –¥–ª—è –≤—Ö–æ–¥—É">
                        </label>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <label class="block">
                                <span class="text-gray-700 font-medium">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ—Å—Ç–µ–π (N) *</span>
                                <input type="number" id="guestCount" min="1" value="1" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-rose-500 focus:ring-rose-500">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-medium">–î–∞—Ç–∞ –ø–æ–¥—ñ—ó (–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</span>
                                <input type="date" id="eventDate" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-teal-500 focus:ring-teal-500">
                            </label>
                        </div>
                        <label class="block">
                            <span class="text-gray-700 font-medium">–í–∞—à–µ —ñ–º'—è (–í–ª–∞—Å–Ω–∏–∫, –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</span>
                            <input type="text" id="ownerName" value="${userName || ''}" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-teal-500 focus:ring-teal-500">
                        </label>

                        <h2 class="text-2xl font-semibold text-gray-800 pt-4 border-t mt-8">–î–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ–¥–∞—Ä—É–Ω–∫—ñ–≤</h2>
                        <div id="giftsContainer" class="space-y-4">
                            <!-- Gift slots will be injected here -->
                        </div>

                        <div class="flex items-center space-x-3 pt-4 border-t">
                            <input type="checkbox" id="hideReserved" class="rounded text-rose-500 focus:ring-rose-500">
                            <label for="hideReserved" class="text-gray-700">–ü—Ä–∏—Ö–æ–≤—É–≤–∞—Ç–∏ –∑–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω—ñ –ø–æ–¥–∞—Ä—É–Ω–∫–∏ –≤—ñ–¥ —ñ–Ω—à–∏—Ö –≥–æ—Å—Ç–µ–π?</label>
                        </div>

                        <button type="submit" class="w-full px-4 py-3 bg-teal-500 text-white font-semibold rounded-xl shadow-lg hover:bg-teal-600 transition-all transform hover:scale-[1.01] shadow-teal-500/40">
                            –ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ç–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É
                        </button>
                    </form>
                </div>
            `;
            
            const form = document.getElementById('createRoomForm');
            const guestCountInput = document.getElementById('guestCount');
            const giftsContainer = document.getElementById('giftsContainer');

            const renderGiftSlots = () => {
                const N = parseInt(guestCountInput.value) || 0;
                let html = '';
                for (let i = 1; i <= N; i++) {
                    const giftId = `gift-${i}`;
                    html += renderGiftCreationCard(i, giftId);
                }
                giftsContainer.innerHTML = html;
            };

            guestCountInput.addEventListener('input', renderGiftSlots);
            form.addEventListener('submit', handleCreateRoomSubmit);
            renderGiftSlots(); // Initial render
            hideLoading();
        }

        /** Helper to render one gift creation card (for Owner view) */
        function renderGiftCreationCard(index, id) {
            const iconOptions = Object.keys(GIFT_ICONS).map(category => 
                `<option value="${category}" data-icon="${GIFT_ICONS[category]}">${GIFT_ICONS[category]} ${category}</option>`
            ).join('');

            return `
                <div id="${id}" class="bg-gray-50 p-5 border border-gray-200 rounded-xl shadow-sm space-y-4 transition-all duration-300">
                    <h3 class="text-lg font-bold text-gray-700">–ü–æ–¥–∞—Ä—É–Ω–æ–∫ #${index} (–¥–ª—è –≥–æ—Å—Ç—è ${index})</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="block">
                            <span class="text-gray-600 text-sm">–ù–∞–∑–≤–∞ –ø–æ–¥–∞—Ä—É–Ω–∫–∞ *</span>
                            <input type="text" name="name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 focus:border-rose-500 focus:ring-rose-500">
                        </label>
                        <label class="block">
                            <span class="text-gray-600 text-sm">–¶—ñ–Ω–∞ (–û—Ü—ñ–Ω–æ—á–Ω–∞, UAH) *</span>
                            <input type="number" name="price" min="0" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 focus:border-rose-500 focus:ring-rose-500">
                        </label>
                    </div>
                    <label class="block">
                        <span class="text-gray-600 text-sm">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –º–∞–≥–∞–∑–∏–Ω (–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</span>
                        <input type="url" name="link" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 focus:border-teal-500 focus:ring-teal-500">
                    </label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <label class="block">
                            <span class="text-gray-600 text-sm">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</span>
                            <select name="category" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 focus:border-teal-500 focus:ring-teal-500">
                                ${iconOptions}
                            </select>
                        </label>
                        <div class="flex items-center space-x-6 mt-4">
                            <span class="text-gray-600 text-sm">–¢–∏–ø:</span>
                            <label class="inline-flex items-center">
                                <input type="radio" name="type-${index}" value="physical" checked class="rounded-full text-rose-500 focus:ring-rose-500">
                                <span class="ml-2 text-gray-700">–§—ñ–∑–∏—á–Ω–∏–π</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="type-${index}" value="electronic" class="rounded-full text-teal-500 focus:ring-teal-500">
                                <span class="ml-2 text-gray-700">–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }

        /** Handles room creation form submission */
        async function handleCreateRoomSubmit(event) {
            event.preventDefault();
            const form = event.target;
            
            const roomName = form.querySelector('#roomName').value.trim();
            let roomId = form.querySelector('#roomIdInput').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            const guestCount = parseInt(form.querySelector('#guestCount').value);
            const eventDate = form.querySelector('#eventDate').value;
            const ownerName = form.querySelector('#ownerName').value.trim();
            const hideReserved = form.querySelector('#hideReserved').checked;

            if (!roomName || !roomId || guestCount < 1) {
                showToast("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è.", 'error');
                return;
            }

            const giftSlots = form.querySelectorAll('#giftsContainer > div');
            const gifts = [];
            let isValid = true;

            giftSlots.forEach((slot, index) => {
                const name = slot.querySelector('input[name="name"]').value.trim();
                const price = parseFloat(slot.querySelector('input[name="price"]').value);
                const link = slot.querySelector('input[name="link"]').value.trim();
                const category = slot.querySelector('select[name="category"]').value;
                const type = slot.querySelector(`input[name="type-${index+1}"]:checked`).value;
                const icon = GIFT_ICONS[category] || GIFT_ICONS['–Ü–Ω—à–µ'];

                if (!name || isNaN(price) || price < 0) {
                    showToast(`–ü–æ–º–∏–ª–∫–∞ —É –ü–æ–¥–∞—Ä—É–Ω–∫—É #${index + 1}: –ù–∞–∑–≤–∞ —Ç–∞ —Ü—ñ–Ω–∞ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ.`, 'error');
                    isValid = false;
                    return;
                }

                gifts.push({
                    id: crypto.randomUUID(),
                    name,
                    price,
                    link,
                    category,
                    type,
                    icon,
                    status: 'available',
                    reservedBy: null,
                    userName: null,
                    boughtBy: null,
                });
            });

            if (!isValid) return;

            const roomData = { roomName, guestCount, eventDate, gifts, ownerName, hideReserved };
            const finalRoomId = await saveRoom(roomData, roomId);

            if (finalRoomId) {
                window.location.hash = `room/${finalRoomId}`;
            }
        }

        /** Renders the share screen after room creation/when owner views a room */
        function renderShareScreen(roomId, roomData) {
            const shareLink = `${window.location.origin}/#room/${roomId}`;
            
            PAGE_CONTAINER.innerHTML = `
                <div class="text-center py-16 px-4 bg-white rounded-xl shadow-lg">
                    <i class="fas fa-check-circle text-6xl text-teal-500 mb-6 animate-pulse"></i>
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">–ö—ñ–º–Ω–∞—Ç—É —Å—Ç–≤–æ—Ä–µ–Ω–æ!</h1>
                    <p class="text-xl text-gray-600 mb-8">–ó–∞–ø—Ä–æ—Å—ñ—Ç—å —Å–≤–æ—ó—Ö –≥–æ—Å—Ç–µ–π –Ω–∞ –ø–æ–¥—ñ—é: <strong class="text-rose-500">"${roomData.name}"</strong></p>

                    <div class="max-w-md mx-auto mb-10">
                        <label class="block text-left mb-2 text-gray-700 font-medium">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –≥–æ—Å—Ç–µ–π:</label>
                        <div class="flex rounded-xl shadow-md overflow-hidden">
                            <input type="text" id="shareLinkInput" value="${shareLink}" readonly class="flex-grow p-3 bg-gray-100 text-gray-800 font-mono text-sm border-none">
                            <button onclick="copyToClipboard('shareLinkInput')" class="px-4 bg-rose-500 text-white hover:bg-rose-600 transition">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <p class="text-left text-sm mt-2 text-gray-500">–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏: <code class="font-mono text-gray-800 font-bold text-lg">${roomId}</code></p>
                    </div>

                    <p class="text-gray-500 mb-6">–¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É —è–∫ –≥—ñ—Å—Ç—å –∞–±–æ —è–∫ –≤–ª–∞—Å–Ω–∏–∫.</p>

                    <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                        <a href="#room/${roomId}" class="px-6 py-3 bg-teal-500 text-white font-semibold rounded-lg hover:bg-teal-600 transition">
                            <i class="fas fa-door-open mr-2"></i> –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫—ñ–º–Ω–∞—Ç—É
                        </a>
                        <a href="#create" class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">
                            <i class="fas fa-plus mr-2"></i> –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É
                        </a>
                    </div>
                </div>
            `;
            hideLoading();
        }

        /** Copies text content to clipboard */
        function copyToClipboard(elementId) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); // For mobile devices
            document.execCommand('copy');
            showToast("–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!");
        }

        /** Renders the main Room View for Guests/Owner */
        function renderRoomView(roomId, roomData) {
            currentRoomId = roomId;
            const isOwner = roomData.ownerId === userId;

            // Initial Guest Name Prompt if not set and not owner
            if (!userName && !isOwner) {
                showModalForName();
                // We render the room first, then show modal, so rendering continues.
            }

            // Group gifts by status for clear display (Reserved/Bought first)
            const availableGifts = roomData.gifts.filter(g => g.status === 'available');
            const reservedGifts = roomData.gifts.filter(g => g.status === 'reserved' && g.reservedBy === userId);
            const othersReservedBought = roomData.gifts.filter(g => 
                (g.status === 'reserved' && g.reservedBy !== userId) || g.status === 'bought'
            );

            // Filter out reserved/bought gifts by others if hideReserved is true AND user is not the owner
            const hiddenGifts = othersReservedBought.filter(g => 
                roomData.hideReserved && !isOwner && g.status !== 'bought'
            );
            const visibleOthersReservedBought = othersReservedBought.filter(g => 
                !(roomData.hideReserved && !isOwner && g.status === 'reserved')
            );
            
            const giftsToShow = [
                ...reservedGifts, // My reservations always first
                ...availableGifts,
                ...visibleOthersReservedBought
            ];

            const renderGiftCards = (gifts) => gifts.map(gift => {
                const isReservedByMe = gift.status === 'reserved' && gift.reservedBy === userId;
                const isBought = gift.status === 'bought';
                const isReservedByOther = gift.status === 'reserved' && gift.reservedBy !== userId;
                
                let statusBadgeClass = '';
                let statusText = '–í—ñ–ª—å–Ω–æ';
                let actionButton = '';
                let cardOpacity = 'opacity-100';
                let action = '';

                if (isBought) {
                    statusBadgeClass = 'status-bought';
                    statusText = `–ö—É–ø–ª–µ–Ω–æ: ${gift.userName || '–ê–Ω–æ–Ω—ñ–º'}`;
                    actionButton = `<button class="w-full py-2 bg-gray-400 text-white font-semibold rounded-lg cursor-not-allowed" disabled>–ö—É–ø–ª–µ–Ω–æ</button>`;
                    cardOpacity = 'opacity-50';
                } else if (isReservedByMe) {
                    statusBadgeClass = 'status-reserved';
                    statusText = '–í–∞—à–∞ –±—Ä–æ–Ω—å';
                    action = `<button onclick="showConfirmModal('${gift.id}', 'available')" class="w-full py-2 bg-rose-500 text-white font-semibold rounded-lg hover:bg-rose-600 transition-all">–°–∫–∞—Å—É–≤–∞—Ç–∏ –±—Ä–æ–Ω—å</button>`;
                    actionButton = `<div class="mt-3 space-y-2">${action}<button onclick="showConfirmModal('${gift.id}', 'bought')" class="w-full py-2 bg-teal-500 text-white font-semibold rounded-lg hover:bg-teal-600 transition-all">–ö—É–ø–ª–µ–Ω–æ <i class="fas fa-check"></i></button></div>`;
                } else if (isReservedByOther) {
                    statusBadgeClass = 'status-reserved';
                    statusText = `–ó–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ: ${gift.userName || '–ê–Ω–æ–Ω—ñ–º'}`;
                    actionButton = `<button class="w-full py-2 bg-gray-400 text-white font-semibold rounded-lg cursor-not-allowed" disabled>–ó–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ</button>`;
                    cardOpacity = 'opacity-70';
                } else { // available
                    statusBadgeClass = 'status-available';
                    statusText = '–í—ñ–ª—å–Ω–æ';
                    actionButton = `<button onclick="showReserveModal('${gift.id}', '${gift.name}')" class="w-full py-2 bg-rose-500 text-white font-semibold rounded-lg hover:bg-rose-600 transition-all transform hover:scale-[1.01]">–ó–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏</button>`;
                }

                const ownerAction = isOwner ? 
                    `<button onclick="deleteGift('${gift.id}')" class="text-rose-500 text-xs hover:underline">–í–∏–¥–∞–ª–∏—Ç–∏</button>` : '';


                return `
                    <div class="gift-card-wrapper bg-white p-6 rounded-xl shadow-lg transform transition-all duration-300 ${cardOpacity} flex flex-col items-center text-center">
                        <div class="gift-circle mb-4 text-5xl flex-shrink-0" style="border-color: ${isReservedByMe ? 'var(--primary-color)' : 'transparent'};">
                            ${gift.icon || GIFT_ICONS['–Ü–Ω—à–µ']}
                        </div>
                        <div class="flex-grow w-full">
                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusBadgeClass} mb-2 inline-block">${statusText}</span>
                            <h3 class="text-lg font-bold text-gray-900">${gift.name}</h3>
                            <p class="text-sm text-gray-500 mb-3">‚âà ${gift.price} UAH</p>
                        </div>
                        
                        <!-- Details on click/tap -->
                        <div class="text-left w-full mt-2 space-y-2 text-sm">
                            ${gift.link ? `<a href="${gift.link}" target="_blank" class="text-teal-500 hover:text-teal-600 transition inline-block"><i class="fas fa-external-link-alt mr-1"></i> –ü–æ—Å–∏–ª–∞–Ω–Ω—è</a>` : ''}
                            <p class="text-xs text-gray-400">${gift.category} | ${gift.type === 'physical' ? '–§—ñ–∑–∏—á–Ω–∏–π' : '–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π'}</p>
                            ${ownerAction}
                        </div>

                        <div class="w-full mt-4">
                            ${actionButton}
                        </div>
                    </div>
                `;
            }).join('');


            PAGE_CONTAINER.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <!-- Room Info & Header -->
                    <div class="mb-8 p-6 bg-white rounded-xl shadow-lg border-t-4 border-rose-500">
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">${roomData.name}</h1>
                        <p class="text-gray-600 mb-2">–û—Ä–≥–∞–Ω—ñ–∑–∞—Ç–æ—Ä: ${roomData.ownerName || '–í–ª–∞—Å–Ω–∏–∫'} | –ö–æ–¥: <code class="font-mono text-rose-500">${roomId}</code></p>
                        ${roomData.eventDate ? `<p class="text-sm text-gray-500"><i class="fas fa-calendar-alt mr-1"></i> –î–∞—Ç–∞ –ø–æ–¥—ñ—ó: ${roomData.eventDate}</p>` : ''}
                        
                        <div class="mt-4 flex flex-wrap items-center text-sm text-gray-700 space-x-4">
                            <span><i class="fas fa-users mr-1"></i> –ì–æ—Å—Ç–µ–π: ${roomData.guestCount}</span>
                            <span><i class="fas fa-gifts mr-1"></i> –ü–æ–¥–∞—Ä—É–Ω–∫—ñ–≤: ${roomData.gifts.length}</span>
                            ${isOwner ? `<span class="text-teal-500 font-semibold"><i class="fas fa-crown mr-1"></i> –í–∏ ‚Äî –í–ª–∞—Å–Ω–∏–∫</span>` : ''}
                        </div>

                        ${isOwner ? 
                            `<div class="mt-4 border-t pt-4">
                                <button onclick="window.location.hash = 'share/${roomId}'" class="px-3 py-1 bg-teal-100 text-teal-700 rounded-lg hover:bg-teal-200 transition-all text-sm">
                                    <i class="fas fa-share-alt mr-1"></i> –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º
                                </button>
                            </div>` : ''}
                    </div>

                    <!-- Gift Grid -->
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">–°–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä—É–Ω–∫—ñ–≤ (${availableGifts.length} –≤—ñ–ª—å–Ω–æ)</h2>
                    
                    ${hiddenGifts.length > 0 ? 
                        `<div class="p-4 mb-6 bg-yellow-100 text-yellow-800 rounded-lg text-sm">
                            <i class="fas fa-info-circle mr-2"></i> ${hiddenGifts.length} –ø–æ–¥–∞—Ä—É–Ω–∫—ñ–≤ –∑–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ —ñ –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ –≤—ñ–¥ –≤–∞—Å.
                        </div>` : ''}

                    <div id="giftGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        ${renderGiftCards(giftsToShow)}
                    </div>

                </div>
            `;
            
            hideLoading();
        }
        
        /** Shows modal to confirm name if guest enters anonymously */
        function showModalForName() {
            const currentHash = window.location.hash;
            const content = `
                <h3 class="text-2xl font-bold text-gray-800 mb-4">–ü—Ä–µ–¥—Å—Ç–∞–≤—Ç–µ—Å—å, –±—É–¥—å –ª–∞—Å–∫–∞</h3>
                <p class="text-gray-600 mb-4">–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è –∞–±–æ –Ω—ñ–∫–Ω–µ–π–º. –¶–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ, —â–æ–± —ñ–Ω—à—ñ –≥–æ—Å—Ç—ñ –±–∞—á–∏–ª–∏, —Ö—Ç–æ –∑–∞–±—Ä–æ–Ω—é–≤–∞–≤ –ø–æ–¥–∞—Ä—É–Ω–æ–∫.</p>
                <input type="text" id="tempGuestNameInput" placeholder="–í–∞—à–µ —ñ–º'—è (–¥–ª—è –±—Ä–æ–Ω—ñ)" value="${userName || ''}" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                
                <div class="flex justify-end space-x-3">
                    <button onclick="closeModal();" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">–ó–∞–ª–∏—à–∏—Ç–∏—Å—è –ê–Ω–æ–Ω—ñ–º–æ–º</button>
                    <button id="modalConfirm" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition font-semibold">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ç–∞ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
                </div>
            `;
            showModal(content, () => {
                const name = document.getElementById('tempGuestNameInput').value.trim();
                if (name) {
                    userName = name;
                    showToast(`–í–∞—à–µ —ñ–º'—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —è–∫ "${userName}".`);
                    // Re-render the room to reflect the new user name for actions
                    if (currentRoomData && currentRoomId) {
                        renderRoomView(currentRoomId, currentRoomData);
                    }
                }
            });
        }

        /** Shows modal for gift reservation */
        function showReserveModal(giftId, giftName) {
            const currentName = userName || '';
            
            const content = `
                <h3 class="text-2xl font-bold text-gray-800 mb-4">–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è: ${giftName}</h3>
                <p class="text-gray-600 mb-4">–í–∏ —Ö–æ—á–µ—Ç–µ –∑–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏ —Ü–µ–π –ø–æ–¥–∞—Ä—É–Ω–æ–∫?</p>
                
                <label class="block mb-4">
                    <span class="text-gray-700 font-medium">–í–∞—à–µ —ñ–º'—è –¥–ª—è –±—Ä–æ–Ω—ñ (–ü–æ–∫–∞–∑—É—î—Ç—å—Å—è —ñ–Ω—à–∏–º) *</span>
                    <input type="text" id="reserveNameInput" required value="${currentName}" placeholder="–Ü–º'—è –∞–±–æ –ê–Ω–æ–Ω—ñ–º" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-rose-500 focus:ring-rose-500">
                </label>

                <label class="block mb-6">
                    <span class="text-gray-700 font-medium">–ö–æ–º–µ–Ω—Ç–∞—Ä (–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</span>
                    <textarea id="reserveComment" rows="2" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö—É–ø–ª—é –≤ —Å—É–±–æ—Ç—É" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-teal-500 focus:ring-teal-500"></textarea>
                </label>

                <div class="flex justify-end space-x-3">
                    <button onclick="closeModal()" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button id="modalConfirm" class="px-4 py-2 bg-rose-500 text-white rounded-lg hover:bg-rose-600 transition font-semibold">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è</button>
                </div>
            `;
            showModal(content, async () => {
                const name = document.getElementById('reserveNameInput').value.trim();
                if (!name) {
                    showToast("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —ñ–º'—è –¥–ª—è –±—Ä–æ–Ω—ñ.", 'error');
                    return;
                }
                userName = name; // Update global user name if provided
                await updateGiftStatus(giftId, 'reserved', name);
            });
        }

        /** Shows generic confirmation modal (for unreserve/bought) */
        function showConfirmModal(giftId, newStatus) {
            const gift = currentRoomData.gifts.find(g => g.id === giftId);
            if (!gift) return;

            let title, message, confirmText;

            if (newStatus === 'available') {
                title = "–°–∫–∞—Å—É–≤–∞—Ç–∏ –±—Ä–æ–Ω—å?";
                message = `–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ –±—Ä–æ–Ω—å –Ω–∞ –ø–æ–¥–∞—Ä—É–Ω–æ–∫ "${gift.name}"? –í—ñ–Ω –∑–Ω–æ–≤—É —Å—Ç–∞–Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∏–º –¥–ª—è —ñ–Ω—à–∏—Ö –≥–æ—Å—Ç–µ–π.`;
                confirmText = "–°–∫–∞—Å—É–≤–∞—Ç–∏ –±—Ä–æ–Ω—å";
            } else if (newStatus === 'bought') {
                title = "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∫—É–ø—ñ–≤–ª—é";
                message = `–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ –≤–∂–µ –∫—É–ø–∏–ª–∏ –ø–æ–¥–∞—Ä—É–Ω–æ–∫ "${gift.name}"? –í—ñ–Ω –±—É–¥–µ –≤—ñ–¥–º—ñ—á–µ–Ω–∏–π —è–∫ "–ö—É–ø–ª–µ–Ω–æ" –¥–ª—è –≤—Å—ñ—Ö –≥–æ—Å—Ç–µ–π.`;
                confirmText = "–¢–∞–∫, –∫—É–ø–ª–µ–Ω–æ";
            } else {
                return;
            }

            const content = `
                <h3 class="text-2xl font-bold text-gray-800 mb-4">${title}</h3>
                <p class="text-gray-600 mb-6">${message}</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeModal()" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">–ù—ñ, —Å–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button id="modalConfirm" class="px-4 py-2 bg-rose-500 text-white rounded-lg hover:bg-rose-600 transition font-semibold">${confirmText}</button>
                </div>
            `;
            showModal(content, async () => {
                await updateGiftStatus(giftId, newStatus, userName);
            });
        }
        
        /** Placeholder for owner to delete a gift */
        async function deleteGift(giftId) {
            if (!db || !currentRoomId || currentRoomData.ownerId !== userId) {
                showToast("–¢—ñ–ª—å–∫–∏ –≤–ª–∞—Å–Ω–∏–∫ –º–æ–∂–µ –≤–∏–¥–∞–ª—è—Ç–∏ –ø–æ–¥–∞—Ä—É–Ω–∫–∏.", 'error');
                return;
            }

            if (confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –ø–æ–¥–∞—Ä—É–Ω–æ–∫?")) {
                const roomDocRef = doc(db, ROOMS_COLLECTION, currentRoomId);
                const updatedGifts = currentRoomData.gifts.filter(g => g.id !== giftId);

                try {
                    await updateDoc(roomDocRef, { gifts: updatedGifts });
                    showToast("–ü–æ–¥–∞—Ä—É–Ω–æ–∫ –≤–∏–¥–∞–ª–µ–Ω–æ.");
                } catch (e) {
                    console.error("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ–¥–∞—Ä—É–Ω–∫–∞:", e);
                    showToast("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è.", 'error');
                }
            }
        }


        // ====================================================================
        // 5. APPLICATION INITIALIZATION
        // ====================================================================

        /** Handles URL hash routing */
        function handleRouteChange() {
            const hash = window.location.hash.substring(1);
            const [route, param] = hash.split('/');

            if (unsubscribeRoom) {
                unsubscribeRoom(); // Clean up old listeners
                unsubscribeRoom = null;
            }
            currentRoomData = null;
            currentRoomId = null;
            
            // Show loading initially, views will hide it
            LOADING_OVERLAY.style.display = 'flex';
            LOADING_OVERLAY.style.opacity = '1';

            if (route === 'home' || route === '') {
                renderHome();
            } else if (route === 'create') {
                renderCreateRoom();
            } else if (route === 'room' && param) {
                // User is entering a room. We subscribe to it.
                subscribeToRoom(param);
            } else if (route === 'share' && param) {
                // Owner view after creation
                if (currentRoomData) {
                    renderShareScreen(param, currentRoomData);
                } else {
                    // Fetch data if not already loaded (e.g., direct link)
                    getDoc(doc(db, ROOMS_COLLECTION, param)).then(docSnap => {
                        if (docSnap.exists() && docSnap.data().ownerId === userId) {
                            currentRoomData = docSnap.data();
                            renderShareScreen(param, currentRoomData);
                        } else {
                            // If user is not the owner or room not found, redirect to room view
                             window.location.hash = `room/${param}`;
                        }
                    }).catch(() => {
                        window.location.hash = 'home';
                    });
                }
            } else {
                window.location.hash = 'home';
            }
        }
        
        window.addEventListener('hashchange', handleRouteChange);
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        document.getElementById('appIdDisplay').textContent = appId;


        // Start the application
        window.onload = function() {
            initFirebase();
        };

        window.copyToClipboard = copyToClipboard;
        window.showJoinModal = showJoinModal;
        window.showReserveModal = showReserveModal;
        window.showConfirmModal = showConfirmModal;
        window.closeModal = closeModal;
        window.deleteGift = deleteGift;

    </script>
</body>
</html>

