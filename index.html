<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤–∞ –∫—ñ–º–Ω–∞—Ç–∞ ‚Äî –ë—Ä–æ–Ω—é–π –ø–æ–¥–∞—Ä—É–Ω–∫–∏ —Ä–∞–∑–æ–º!</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (Modern & Clean) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles & Animation Definitions */
        :root {
            --color-primary: #06B6D4; /* Cyan/Teal for accent */
            --color-reserved: #F97316; /* Orange for reserved */
            --color-bought: #10B981; /* Emerald for bought */
            --color-bg: #F8F9FB; /* Light background */
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--color-bg);
            color: #1F2937; /* Dark text */
            min-height: 100vh;
        }

        /* Minimalist Card Styling */
        .gift-card {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            position: relative;
        }

        .gift-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Pulsing animation for reserved/pending */
        @keyframes pulse-reserved {
            0%, 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); }
        }

        .pulsing {
            animation: pulse-reserved 2s infinite;
        }

        /* Modal backdrop transition */
        .modal-enter-active, .modal-leave-active {
            transition: opacity 0.3s;
        }
        .modal-enter-from, .modal-leave-to {
            opacity: 0;
        }
        .modal-content-enter-active {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-content-enter-from {
            transform: scale(0.9);
        }

        /* Adaptive grid for gifts */
        #gift-list {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        }

        @media (min-width: 640px) {
            #gift-list {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }
        }
        @media (min-width: 1024px) {
            #gift-list {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto">
        <!-- Content will be rendered here by JavaScript -->
        <div class="flex justify-center items-center h-[50vh] text-gray-500">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-teal-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
        </div>
    </div>

    <!-- Modal Placeholder -->
    <div id="modal-container"></div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs, runTransaction, arrayUnion, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('debug');

        // --- Global Variables (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Application State ---
        let db, auth;
        let userId = null;
        let userName = ''; // User's name entered on login/creation
        let currentView = 'landing';
        let currentRoomId = null;
        let roomData = null; // Stores { ownerId, title, guestsCount, gifts }

        // --- Constants ---
        const PUBLIC_COLLECTION_PATH = `/artifacts/${appId}/public/data/rooms`;
        const APP_NAME = '–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤–∞ –∫—ñ–º–Ω–∞—Ç–∞';

        // --- Utility Functions ---

        /** Generates a unique, short ID (placeholder for a better ID gen) */
        const generateRoomId = () => Math.random().toString(36).substring(2, 8).toUpperCase();

        /** Gets the reference to a specific room document */
        const getRoomRef = (roomId) => doc(db, PUBLIC_COLLECTION_PATH, roomId);

        /** Gets URL parameters */
        const getUrlParams = () => {
            const params = new URLSearchParams(window.location.search);
            return {
                view: params.get('view'),
                room: params.get('room'),
                role: params.get('role'), // 'owner' or 'guest'
            };
        };

        /** * –û–Ω–æ–≤–ª—é—î URL, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ª–∏—à–µ –ø–æ—à—É–∫–æ–≤—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ (?...)
         * –¶–µ –∑–∞–±–µ–∑–ø–µ—á—É—î –Ω–∞–¥—ñ–π–Ω–∏–π —Ä–æ—É—Ç–∏–Ω–≥ –Ω–∞ —Å—Ç–∞—Ç–∏—á–Ω–∏—Ö —Ö–æ—Å—Ç–∏–Ω–≥–∞—Ö (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, GitHub Pages).
         */
        const updateUrl = (params) => {
            const url = new URL(window.location.href.split('?')[0]); // Start with clean URL path
            Object.keys(params).forEach(key => {
                if (params[key] !== null) {
                    url.searchParams.set(key, params[key]);
                }
            });
            window.history.pushState({}, '', url.toString());
        };

        /** Simple Toast Notification System (replaces alert()) */
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            let bgColor = 'bg-teal-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'warning') bgColor = 'bg-yellow-500';

            toast.className = `fixed bottom-4 right-4 p-4 rounded-lg text-white shadow-xl transition-all duration-300 transform translate-y-0 opacity-100 ${bgColor}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-full', 'opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        };

        // --- Authentication and Initialization ---

        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. Cannot initialize.");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth state to settle
                return new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            // Pre-load default name if necessary
                            userName = `–ì—ñ—Å—Ç—å-${userId.substring(0, 4)}`;
                            console.log("Firebase initialized. User ID:", userId);

                            // Check for the "test" room and create it if it doesn't exist
                            await ensureTestRoomExists();

                            resolve();
                        } else {
                            // Should not happen with anonymous sign-in, but handle if it does
                            console.error("Authentication failed.");
                            resolve();
                        }
                        unsubscribe();
                    });
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        };

        /** Ensures the default 'test' room is available */
        const ensureTestRoomExists = async () => {
            const testRoomId = 'TEST';
            const roomRef = getRoomRef(testRoomId);
            const docSnap = await getDoc(roomRef);

            if (!docSnap.exists()) {
                console.log(`Creating default room: ${testRoomId}`);
                const defaultGifts = [
                    { id: 'g1', name: '–ö–Ω–∏–≥–∞ ¬´–ê—Ç–ª–∞–Ω—Ç¬ª', price: 850, status: 'AVAILABLE', icon: 'üìö', category: '–ö–Ω–∏–≥–∏', type: '–§—ñ–∑–∏—á–Ω–∏–π', priority: 1, reservedBy: null, reservedName: null },
                    { id: 'g2', name: '–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –≤ SPA', price: 2000, status: 'AVAILABLE', icon: 'üßñ‚Äç‚ôÄÔ∏è', category: '–í—Ä–∞–∂–µ–Ω–Ω—è', type: '–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π', priority: 2, reservedBy: null, reservedName: null },
                    { id: 'g3', name: '–ö–∞–≤–æ–≤–∞—Ä–∫–∞', price: 4500, status: 'AVAILABLE', icon: '‚òï', category: '–¢–µ—Ö–Ω—ñ–∫–∞', type: '–§—ñ–∑–∏—á–Ω–∏–π', priority: 3, reservedBy: null, reservedName: null },
                    { id: 'g4', name: '–ö–≤–∏—Ç–∫–∏ –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç', price: 1500, status: 'AVAILABLE', icon: 'üé∂', category: '–í—Ä–∞–∂–µ–Ω–Ω—è', type: '–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π', priority: 4, reservedBy: null, reservedName: null },
                    { id: 'g5', name: '–¢–µ–ø–ª–∏–π –ø–ª–µ–¥', price: 1200, status: 'AVAILABLE', icon: 'üß∏', category: '–î—ñ–º', type: '–§—ñ–∑–∏—á–Ω–∏–π', priority: 5, reservedBy: null, reservedName: null },
                ];

                await setDoc(roomRef, {
                    ownerId: 'default-owner', // This is a system-controlled ID
                    title: '–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è (–¢–µ—Å—Ç)',
                    description: '–¢–µ—Å—Ç–æ–≤–∞ –∫—ñ–º–Ω–∞—Ç–∞ –Ω–∞ 5 –≥–æ—Å—Ç–µ–π. –°–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏ –ø–æ–¥–∞—Ä—É–Ω–æ–∫!',
                    guestsCount: 5,
                    createdAt: serverTimestamp(),
                    gifts: defaultGifts,
                    hideReserved: false // Default setting
                });
                console.log(`Default room ${testRoomId} created.`);
            }
        };

        // --- Core Application Logic / Routing ---

        /** Changes the current application view */
        const navigate = (view, params = {}) => {
            currentView = view;
            if (params.roomId) currentRoomId = params.roomId;
            
            // –Ø–∫—â–æ –º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É –∫—ñ–º–Ω–∞—Ç–∏, –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ 'room' —Ç–∞ 'role' —É URL
            if (view === 'roomView' || view === 'roomLink' || view === 'guestLogin') {
                updateUrl({ 
                    view: null, // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ 'view' –∑ URL, —è–∫—â–æ —î 'room'
                    room: currentRoomId,
                    role: params.role || null
                });
            } else {
                // –î–ª—è —ñ–Ω—à–∏—Ö —Å—Ç–æ—Ä—ñ–Ω–æ–∫ (landing, createRoom) –æ—á–∏—â—É—î–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∫—ñ–º–Ω–∞—Ç–∏
                updateUrl({ 
                    view: view,
                    room: null,
                    role: null
                });
            }
            
            renderApp();
        };

        /** –û–±—Ä–æ–±–∫–∞ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ URL (–¥–ª—è GitHub Pages) */
        const handleInitialRoute = () => {
            const params = getUrlParams();
            if (params.room) {
                currentRoomId = params.room;
                // –Ø–∫—â–æ –≤ URL —î –ø–∞—Ä–∞–º–µ—Ç—Ä –∫—ñ–º–Ω–∞—Ç–∏, –≤–∏–∑–Ω–∞—á–∞—î–º–æ —Ä–æ–ª—å —ñ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ
                if (params.role === 'owner') {
                    navigate('roomView', { roomId: params.room, role: 'owner' });
                } else {
                    navigate('guestLogin', { roomId: params.room });
                }
            } else {
                navigate('landing');
            }
        };

        // --- Firestore Interaction / Realtime Listener ---

        let unsubscribeRoomListener = null;

        const startRoomListener = (roomId) => {
            if (unsubscribeRoomListener) {
                unsubscribeRoomListener();
            }

            const roomRef = getRoomRef(roomId);
            unsubscribeRoomListener = onSnapshot(roomRef, (docSnap) => {
                if (docSnap.exists()) {
                    roomData = docSnap.data();
                    renderApp(); // Re-render the view when data changes
                } else {
                    showToast(`–ö—ñ–º–Ω–∞—Ç–∞ –∑ –∫–æ–¥–æ–º ${roomId} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞.`, 'error');
                    navigate('landing');
                }
            }, (error) => {
                console.error("Error listening to room:", error);
                showToast("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –∫—ñ–º–Ω–∞—Ç–∏.", 'error');
                navigate('landing');
            });
        };

        // --- Transactional Updates ---

        const handleReserveGift = async (giftId) => {
            if (!currentRoomId || !userId || !userName) {
                showToast("–ü–æ–º–∏–ª–∫–∞: –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç–∏ –∞–±–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.", 'error');
                return;
            }

            try {
                const roomRef = getRoomRef(currentRoomId);

                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(roomRef);
                    if (!docSnap.exists()) {
                        throw "–ö—ñ–º–Ω–∞—Ç–∞ –Ω–µ —ñ—Å–Ω—É—î!";
                    }

                    const room = docSnap.data();
                    const gifts = room.gifts || [];
                    const giftIndex = gifts.findIndex(g => g.id === giftId);

                    if (giftIndex === -1) {
                        throw "–ü–æ–¥–∞—Ä—É–Ω–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.";
                    }

                    const gift = gifts[giftIndex];

                    if (gift.status !== 'AVAILABLE') {
                        // Check if current user is trying to reserve an already reserved gift
                        if (gift.status === 'RESERVED' && gift.reservedBy === userId) {
                            // If user is already the one reserving, treat it as a success/no change
                            return;
                        }
                        throw "–¶–µ–π –ø–æ–¥–∞—Ä—É–Ω–æ–∫ –≤–∂–µ –∑–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ –∞–±–æ –∫—É–ø–ª–µ–Ω–æ.";
                    }

                    // Perform the reservation
                    gifts[giftIndex] = {
                        ...gift,
                        status: 'RESERVED',
                        reservedBy: userId,
                        reservedName: userName,
                        reservationTime: serverTimestamp()
                    };

                    transaction.update(roomRef, { gifts: gifts });
                    showToast(`–í–∏ –∑–∞–±—Ä–æ–Ω—é–≤–∞–ª–∏: ${gift.name}`, 'success');
                });

            } catch (e) {
                console.error("Reservation failed:", e);
                showToast(`–ü–æ–º–∏–ª–∫–∞ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è: ${e}`, 'error');
            }
        };

        const handleCancelReservation = async (giftId) => {
            if (!currentRoomId || !userId) return;
            const roomRef = getRoomRef(currentRoomId);

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(roomRef);
                    const room = docSnap.data();
                    const gifts = room.gifts || [];
                    const giftIndex = gifts.findIndex(g => g.id === giftId);
                    const gift = gifts[giftIndex];

                    if (gift.status === 'RESERVED' && (gift.reservedBy === userId || room.ownerId === userId)) {
                        gifts[giftIndex] = {
                            ...gift,
                            status: 'AVAILABLE',
                            reservedBy: null,
                            reservedName: null,
                            reservationTime: null
                        };
                        transaction.update(roomRef, { gifts: gifts });
                        showToast(`–ë—Ä–æ–Ω—å –Ω–∞ ${gift.name} —Å–∫–∞—Å–æ–≤–∞–Ω–æ.`, 'warning');
                    } else {
                        throw "–ù–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏ –±—Ä–æ–Ω—å. –í–∏ –Ω–µ —î –≤–ª–∞—Å–Ω–∏–∫–æ–º –±—Ä–æ–Ω—ñ –∞–±–æ –≤–ª–∞—Å–Ω–∏–∫–æ–º –∫—ñ–º–Ω–∞—Ç–∏.";
                    }
                });
            } catch (e) {
                console.error("Cancel reservation failed:", e);
                showToast(`–ü–æ–º–∏–ª–∫–∞ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è: ${e}`, 'error');
            }
        };

        const handleConfirmBought = async (giftId) => {
            if (!currentRoomId || !userId) return;
            const roomRef = getRoomRef(currentRoomId);

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(roomRef);
                    const room = docSnap.data();
                    const gifts = room.gifts || [];
                    const giftIndex = gifts.findIndex(g => g.id === giftId);
                    const gift = gifts[giftIndex];

                    // Check if reserved by user or user is owner
                    if (gift.reservedBy === userId || room.ownerId === userId) {
                        gifts[giftIndex] = {
                            ...gift,
                            status: 'BOUGHT',
                            boughtBy: userId,
                            boughtName: userName || gift.reservedName,
                            boughtTime: serverTimestamp()
                        };
                        transaction.update(roomRef, { gifts: gifts });
                        showToast(`–ü–æ–¥–∞—Ä—É–Ω–æ–∫ ${gift.name} –ø–æ–∑–Ω–∞—á–µ–Ω–æ —è–∫ –ö–£–ü–õ–ï–ù–û!`, 'success');
                    } else {
                        throw "–¢—ñ–ª—å–∫–∏ –≤–ª–∞—Å–Ω–∏–∫ –∫—ñ–º–Ω–∞—Ç–∏ –∞–±–æ —Ç–æ–π, —Ö—Ç–æ –∑–∞–±—Ä–æ–Ω—é–≤–∞–≤, –º–æ–∂–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –ø–æ–∫—É–ø–∫—É.";
                    }
                });
            } catch (e) {
                console.error("Confirm bought failed:", e);
                showToast(`–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–æ–∫—É–ø–∫–∏: ${e}`, 'error');
            }
        };

        // --- UI Rendering Components ---

        /** Renders the Logo and main application header */
        const renderHeader = (title) => `
            <header class="mb-8 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <a href="${window.location.origin}${window.location.pathname.split('?')[0]}" onclick="window.app.navigate('landing')" class="flex items-center space-x-2 text-xl font-extrabold text-gray-800 transition duration-150 ease-in-out hover:text-teal-600">
                        <span class="p-2 bg-teal-200 text-teal-600 rounded-full">üéÅ</span>
                        <span>${APP_NAME}</span>
                    </a>
                    <h2 class="text-xl font-semibold text-gray-700">${title}</h2>
                </div>
            </header>
        `;

        // --- 1. Landing View ---
        const renderLanding = () => {
            return `
                ${renderHeader('–ì–æ–ª–æ–≤–Ω–∞')}
                <main class="text-center p-6 bg-white rounded-xl shadow-lg">
                    <h1 class="text-3xl font-bold mb-4 text-gray-800">–ë—Ä–æ–Ω—é–π—Ç–µ –ø–æ–¥–∞—Ä—É–Ω–∫–∏ —Ä–∞–∑–æ–º!</h1>
                    <p class="text-gray-600 mb-8 max-w-md mx-auto">
                        –ü—Ä–æ—Å—Ç–∏–π —Å–µ—Ä–≤—ñ—Å, –¥–µ –≤–ª–∞—Å–Ω–∏–∫ —Å—Ç–≤–æ—Ä—é—î —Å–ø–∏—Å–æ–∫ –±–∞–∂–∞–Ω–∏—Ö –ø–æ–¥–∞—Ä—É–Ω–∫—ñ–≤, –∞ –≥–æ—Å—Ç—ñ –æ–±–∏—Ä–∞—é—Ç—å, –±—Ä–æ–Ω—é—é—Ç—å —Ç–∞ –∫—É–ø—É—é—Ç—å —ó—Ö –±–µ–∑ –¥—É–±–ª—é–≤–∞–Ω–Ω—è.
                    </p>

                    <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mb-8">
                        <button onclick="window.app.navigate('createRoom')"
                                class="w-full sm:w-auto px-6 py-3 bg-teal-600 text-white font-semibold rounded-xl shadow-md hover:bg-teal-700 transition duration-150">
                            –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É (–í–ª–∞—Å–Ω–∏–∫)
                        </button>
                        <button onclick="document.getElementById('join-section').classList.toggle('hidden')"
                                class="w-full sm:w-auto px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition duration-150">
                            –£–≤—ñ–π—Ç–∏ –≤ –∫—ñ–º–Ω–∞—Ç—É (–ì—ñ—Å—Ç—å)
                        </button>
                    </div>

                    <div id="join-section" class="hidden mt-6 p-4 border border-gray-200 rounded-xl bg-gray-50 max-w-sm mx-auto transition duration-300">
                        <h3 class="text-lg font-medium mb-3">–í—Ö—ñ–¥ –∑–∞ –∫–æ–¥–æ–º</h3>
                        <input type="text" id="room-code-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, TEST)"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 mb-3 uppercase text-center text-lg font-bold">
                        <button onclick="window.app.handleJoinRoom()"
                                class="w-full px-4 py-2 bg-teal-600 text-white font-medium rounded-lg hover:bg-teal-700 transition duration-150">
                            –£–≤—ñ–π—Ç–∏
                        </button>
                    </div>
                </main>
                <footer class="mt-12 text-center text-gray-500 text-sm">
                    &copy; 2024 ${APP_NAME}. –£—Å—ñ –ø—Ä–∞–≤–∞ –∑–∞—Ö–∏—â–µ–Ω—ñ.
                </footer>
            `;
        };

        window.app.handleJoinRoom = () => {
            const code = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (code) {
                navigate('guestLogin', { roomId: code });
            } else {
                showToast("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏.", 'warning');
            }
        };

        // --- 2. Create Room / Add Gifts View ---
        const renderCreateRoom = () => {
            if (currentView === 'createRoom') {
                // Initial room creation form
                return `
                    ${renderHeader('–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –∫—ñ–º–Ω–∞—Ç–∏')}
                    <main class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                        <h3 class="text-2xl font-bold mb-6 text-gray-800">–û—Å–Ω–æ–≤–Ω—ñ –¥–µ—Ç–∞–ª—ñ</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="owner-name" class="block text-sm font-medium text-gray-700">–í–∞—à–µ —ñ–º'—è (–í–ª–∞—Å–Ω–∏–∫)</label>
                                <input type="text" id="owner-name" value="${userName || ''}" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –Ü—Ä–∏–Ω–∞"
                                       class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <label for="event-title" class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞ –ø–æ–¥—ñ—ó/—Å–≤—è—Ç–∞ (–û–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                                <input type="text" id="event-title" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –Ü—Ä–∏"
                                       class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <label for="guests-count" class="block text-sm font-medium text-gray-700">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ—Å—Ç–µ–π (N)</label>
                                <input type="number" id="guests-count" min="1" value="5"
                                       class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <label for="event-date" class="block text-sm font-medium text-gray-700">–î–∞—Ç–∞ –ø–æ–¥—ñ—ó (–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</label>
                                <input type="date" id="event-date"
                                       class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                            </div>
                        </div>

                        <button onclick="window.app.startAddingGifts()"
                                class="mt-8 w-full px-6 py-3 bg-teal-600 text-white font-semibold rounded-xl shadow-md hover:bg-teal-700 transition duration-150">
                            –î–∞–ª—ñ: –î–æ–¥–∞—Ç–∏ –ø–æ–¥–∞—Ä—É–Ω–∫–∏
                        </button>
                    </main>
                `;
            } else if (currentView === 'addGifts') {
                return renderAddGiftsForm();
            }
        };

        let draftRoom = { ownerName: '', title: '', guestsCount: 5, gifts: [] };

        window.app.startAddingGifts = () => {
            const ownerNameInput = document.getElementById('owner-name').value.trim();
            const titleInput = document.getElementById('event-title').value.trim();
            const countInput = parseInt(document.getElementById('guests-count').value);

            if (!titleInput || isNaN(countInput) || countInput < 1) {
                showToast("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –ø–æ–¥—ñ—ó —Ç–∞ –¥—ñ–π—Å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ—Å—Ç–µ–π (N > 0).", 'warning');
                return;
            }

            draftRoom.ownerName = ownerNameInput || `–í–ª–∞—Å–Ω–∏–∫-${userId.substring(0, 4)}`;
            draftRoom.title = titleInput;
            draftRoom.guestsCount = countInput;

            // Initialize gift slots if they haven't been created yet
            if (draftRoom.gifts.length !== countInput) {
                const newGifts = [];
                for (let i = 0; i < countInput; i++) {
                    newGifts.push({
                        id: `g${i + 1}`,
                        name: '',
                        price: 0,
                        description: '',
                        link: '',
                        icon: '‚ùì',
                        category: '–†—ñ–∑–Ω–µ',
                        type: '–§—ñ–∑–∏—á–Ω–∏–π',
                        priority: i + 1,
                        status: 'AVAILABLE',
                        reservedBy: null,
                        reservedName: null,
                    });
                }
                draftRoom.gifts = newGifts;
            }

            navigate('addGifts');
        };

        const GIFT_ICONS = ['üéÅ', 'üìö', '‚òï', 'üíª', 'üßò', 'üéß', 'üí∏', 'üñºÔ∏è', 'üß∏', 'üç∑'];

        const renderAddGiftsForm = () => {
            const giftForms = draftRoom.gifts.map((gift, index) => `
                <div class="gift-slot p-5 border border-gray-200 rounded-xl bg-gray-50 transition duration-300 hover:shadow-md" data-index="${index}">
                    <h4 class="text-xl font-semibold mb-3 text-teal-600">–ü–æ–¥–∞—Ä—É–Ω–æ–∫ #${index + 1}</h4>
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <input type="text" value="${gift.icon}" maxlength="2" data-field="icon" placeholder="–Ü–∫–æ–Ω–∫–∞ (—Å–º–∞–π–ª–∏–∫)"
                                   class="w-12 h-12 text-2xl text-center border-2 border-teal-300 rounded-full focus:outline-none"
                                   oninput="window.app.updateDraftGift(${index}, 'icon', this.value)">
                            <select onchange="window.app.updateDraftGift(${index}, 'icon', this.value)" class="p-2 border border-gray-300 rounded-lg text-sm">
                                <option value="${gift.icon}">${gift.icon} (–ø–æ—Ç–æ—á–Ω–∏–π)</option>
                                ${GIFT_ICONS.map(i => `<option value="${i}">${i}</option>`).join('')}
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-500">–ù–∞–∑–≤–∞ –ø–æ–¥–∞—Ä—É–Ω–∫–∞*</label>
                            <input type="text" value="${gift.name}" data-field="name" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –ù–∞–≤—É—à–Ω–∏–∫–∏ Sony WH-1000XM5"
                                   class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"
                                   oninput="window.app.updateDraftGift(${index}, 'name', this.value)">
                        </div>

                        <div class="flex space-x-3">
                            <div class="w-1/2">
                                <label class="block text-xs font-medium text-gray-500">–¶—ñ–Ω–∞ (–æ—Ü—ñ–Ω–æ—á–Ω–∞, –≥—Ä–Ω)*</label>
                                <input type="number" value="${gift.price || ''}" data-field="price" min="0" placeholder="1500"
                                       class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"
                                       oninput="window.app.updateDraftGift(${index}, 'price', parseFloat(this.value))">
                            </div>
                            <div class="w-1/2">
                                <label class="block text-xs font-medium text-gray-500">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                                <input type="text" value="${gift.category}" data-field="category" placeholder="–¢–µ—Ö–Ω—ñ–∫–∞"
                                       class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"
                                       oninput="window.app.updateDraftGift(${index}, 'category', this.value)">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-500">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –º–∞–≥–∞–∑–∏–Ω (–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <input type="url" value="${gift.link}" data-field="link" placeholder="https://..."
                                   class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"
                                   oninput="window.app.updateDraftGift(${index}, 'link', this.value)">
                        </div>

                        <div>
                            <label class="inline-flex items-center">
                                <input type="checkbox" data-field="type" ${gift.type === '–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π' ? 'checked' : ''}
                                       onchange="window.app.updateDraftGift(${index}, 'type', this.checked ? '–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π' : '–§—ñ–∑–∏—á–Ω–∏–π')"
                                       class="rounded text-teal-600 focus:ring-teal-500">
                                <span class="ml-2 text-sm text-gray-700">–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π –ø–æ–¥–∞—Ä—É–Ω–æ–∫ (—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç/–ø—ñ–¥–ø–∏—Å–∫–∞)</span>
                            </label>
                        </div>

                    </div>
                </div>
            `).join('');

            return `
                ${renderHeader(`–î–æ–¥–∞–≤–∞–Ω–Ω—è ${draftRoom.gifts.length} –ø–æ–¥–∞—Ä—É–Ω–∫—ñ–≤ –¥–ª—è –∫—ñ–º–Ω–∞—Ç–∏ "${draftRoom.title}"`)}
                <main class="pb-24">
                    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
                        ${giftForms}
                    </div>
                </main>
                <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 shadow-2xl">
                    <button onclick="window.app.finalizeRoomCreation()"
                            class="w-full px-6 py-3 bg-rose-600 text-white font-semibold rounded-xl shadow-md hover:bg-rose-700 transition duration-150">
                        –ó–±–µ—Ä–µ–≥—Ç–∏ —Ç–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É
                    </button>
                </div>
            `;
        };

        window.app.updateDraftGift = (index, field, value) => {
            if (draftRoom.gifts[index]) {
                draftRoom.gifts[index][field] = value;
            }
        };

        window.app.finalizeRoomCreation = async () => {
            const requiredFields = ['name', 'price'];
            let isValid = true;

            for (const gift of draftRoom.gifts) {
                if (!gift.name || gift.price <= 0 || isNaN(gift.price)) {
                    isValid = false;
                    break;
                }
            }

            if (!isValid) {
                showToast("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –ù–∞–∑–≤—É —Ç–∞ –¥—ñ–π—Å–Ω—É –¶—ñ–Ω—É (–±—ñ–ª—å—à–µ 0) –¥–ª—è –í–°–Ü–• –ø–æ–¥–∞—Ä—É–Ω–∫—ñ–≤.", 'error');
                return;
            }

            try {
                const newRoomId = generateRoomId();
                const roomRef = getRoomRef(newRoomId);

                await setDoc(roomRef, {
                    ownerId: userId,
                    ownerName: draftRoom.ownerName,
                    title: draftRoom.title,
                    guestsCount: draftRoom.guestsCount,
                    createdAt: serverTimestamp(),
                    gifts: draftRoom.gifts,
                    hideReserved: false, // Default setting: show reserved items
                });

                showToast(`–ö—ñ–º–Ω–∞—Ç–∞ "${draftRoom.title}" —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–∞!`, 'success');
                navigate('roomLink', { roomId: newRoomId, role: 'owner' });

            } catch (e) {
                console.error("Room creation failed:", e);
                showToast("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –∫—ñ–º–Ω–∞—Ç–∏. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.", 'error');
            }
        };

        // --- 3. Room Link View (Owner) ---
        const renderRoomLink = () => {
            if (!roomData) return `<div class="p-8 text-center">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>`;

            // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–∏—Å—Ç–æ–≥–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ø–æ—Ç–æ—á–Ω–∏–π —à–ª—è—Ö
            const cleanPath = window.location.href.split('?')[0];
            const roomLink = `${cleanPath}?room=${currentRoomId}`;

            const isOwner = roomData.ownerId === userId;

            // Owner sees this link page, Guest is redirected to room view
            if (!isOwner) {
                 return renderRoomView();
            }

            return `
                ${renderHeader('–ö—ñ–º–Ω–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞!')}
                <main class="bg-white p-6 sm:p-8 rounded-xl shadow-lg text-center">
                    <div class="text-6xl mb-6">üéâ</div>
                    <h1 class="text-3xl font-bold mb-2 text-gray-800">${roomData.title}</h1>
                    <p class="text-xl text-teal-600 font-medium mb-6">–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏: <span class="p-2 bg-teal-100 rounded-lg">${currentRoomId}</span></p>

                    <div class="mb-8">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –≥–æ—Å—Ç–µ–π (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ü–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è)</label>
                        <input type="text" value="${roomLink}" readonly id="room-link-input"
                               class="w-full p-3 border border-gray-300 rounded-lg text-center font-mono text-sm bg-gray-50 mb-3">
                        <button onclick="window.app.copyLink('${roomLink}')"
                                class="px-6 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150">
                            –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
                        </button>
                    </div>

                    <p class="text-gray-600 mb-6">–¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É –∫—ñ–º–Ω–∞—Ç–∏ —è–∫ **–í–ª–∞—Å–Ω–∏–∫**.</p>

                    <button onclick="window.app.viewRoomAsOwner()"
                            class="w-full sm:w-1/2 px-6 py-3 bg-rose-600 text-white font-semibold rounded-xl hover:bg-rose-700 transition duration-150">
                        –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∫—ñ–º–Ω–∞—Ç–∏
                    </button>
                </main>
            `;
        };

        window.app.copyLink = (link) => {
             // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ document.execCommand('copy') –¥–ª—è –∫—Ä–∞—â–æ—ó —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ iFrame/Canvas
             const tempInput = document.createElement('input');
             document.body.appendChild(tempInput);
             tempInput.value = link;
             tempInput.select();
             try {
                document.execCommand('copy');
                showToast("–ü–æ—Å–∏–ª–∞–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!", 'success');
             } catch (err) {
                 console.error('Copy failed:', err);
                 showToast("–ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É.", 'error');
             }
             document.body.removeChild(tempInput);
        };

        window.app.viewRoomAsOwner = () => {
             // –ù–∞–≤—ñ–≥–∞—Ü—ñ—è –æ–¥—Ä–∞–∑—É –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É –∫—ñ–º–Ω–∞—Ç–∏, –≤—Å—Ç–∞–Ω–æ–≤–ª—é—é—á–∏ —Ä–æ–ª—å "owner" –≤ URL
            navigate('roomView', { roomId: currentRoomId, role: 'owner' });
        };

        // --- 4. Guest Login View ---
        const renderGuestLogin = () => {
            return `
                ${renderHeader('–í—Ö—ñ–¥ —É –∫—ñ–º–Ω–∞—Ç—É')}
                <main class="text-center p-6 bg-white rounded-xl shadow-lg max-w-sm mx-auto">
                    <div class="text-5xl mb-4">üö™</div>
                    <h1 class="text-2xl font-bold mb-4 text-gray-800">–í–∏ –∑–∞—Ö–æ–¥–∏—Ç–µ —É –∫—ñ–º–Ω–∞—Ç—É: <span class="text-teal-600">${currentRoomId}</span></h1>
                    <p class="text-gray-600 mb-6">–í–≤–µ–¥—ñ—Ç—å —Å–≤–æ—î —ñ–º'—è –∞–±–æ –Ω—ñ–∫–Ω–µ–π–º, —â–æ–± —ñ–Ω—à—ñ –≥–æ—Å—Ç—ñ –∑–Ω–∞–ª–∏, —Ö—Ç–æ –±—Ä–æ–Ω—é—î –ø–æ–¥–∞—Ä—É–Ω–æ–∫.</p>

                    <input type="text" id="guest-name-input" placeholder="–í–∞—à–µ —ñ–º'—è (–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)" value="${userName.startsWith('–ì—ñ—Å—Ç—å') ? '' : userName}"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 mb-4">

                    <button onclick="window.app.loginAsGuest()"
                            class="w-full px-6 py-3 bg-teal-600 text-white font-semibold rounded-xl hover:bg-teal-700 transition duration-150">
                        –£–≤—ñ–π—Ç–∏ –¥–æ –∫—ñ–º–Ω–∞—Ç–∏
                    </button>
                </main>
            `;
        };

        window.app.loginAsGuest = () => {
            const name = document.getElementById('guest-name-input').value.trim();
            userName = name || `–ê–Ω–æ–Ω—ñ–º–Ω–∏–π –≥—ñ—Å—Ç—å`;
            showToast(`–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ, ${userName}!`, 'success');
            navigate('roomView', { role: 'guest' });
        };


        // --- 5. Main Room View (Guest/Owner) ---

        /** Renders a single Gift Card component */
        const renderGiftCard = (gift) => {
            const statusClass = {
                'AVAILABLE': 'bg-teal-500 text-white',
                'RESERVED': 'bg-orange-500 text-white pulsing',
                'BOUGHT': 'bg-emerald-600 text-white',
            }[gift.status] || 'bg-gray-400 text-white';

            const isReservedByMe = gift.status === 'RESERVED' && gift.reservedBy === userId;
            const isBought = gift.status === 'BOUGHT';
            const isOwner = roomData?.ownerId === userId;
            const isGuest = !isOwner;

            let actionButton = '';
            let statusText = '';
            let cardClasses = 'gift-card bg-white p-4 rounded-3xl shadow-xl flex flex-col items-center text-center relative';

            if (isBought) {
                statusText = `–ö–£–ü–õ–ï–ù–û: ${gift.boughtName || '–ê–Ω–æ–Ω—ñ–º–Ω–æ'}`;
                cardClasses = 'gift-card bg-emerald-50 p-4 rounded-3xl shadow-xl flex flex-col items-center text-center relative opacity-70';
            } else if (isReservedByMe) {
                statusText = `–ó–ê–ë–†–û–ù–¨–û–í–ê–ù–û –í–ê–ú–ò`;
                actionButton = `
                    <button onclick="window.app.openConfirmBoughtModal('${gift.id}')" class="w-full mt-3 px-4 py-2 text-white font-bold rounded-lg bg-emerald-600 hover:bg-emerald-700 transition duration-150">
                        –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∫—É–ø—ñ–≤–ª—é
                    </button>
                    <button onclick="window.app.openCancelReservationModal('${gift.id}')" class="w-full mt-2 px-4 py-2 text-gray-700 font-medium rounded-lg bg-gray-200 hover:bg-gray-300 transition duration-150">
                        –°–∫–∞—Å—É–≤–∞—Ç–∏ –±—Ä–æ–Ω—å
                    </button>
                `;
            } else if (gift.status === 'RESERVED') {
                statusText = `–ó–ê–ë–†–û–ù–¨–û–í–ê–ù–û: ${gift.reservedName || '–ê–Ω–æ–Ω—ñ–º–Ω–æ'}`;
                // Guests don't see action button if reserved by others
            } else { // AVAILABLE
                statusText = '–í–Ü–õ–¨–ù–û';
                actionButton = `
                    <button onclick="window.app.openReserveModal('${gift.id}')" class="w-full mt-3 px-4 py-2 text-white font-bold rounded-lg bg-teal-600 hover:bg-teal-700 transition duration-150">
                        –ó–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏
                    </button>
                `;
            }

            // Owner can confirm bought for any reserved gift
            if (isOwner && gift.status === 'RESERVED' && !isReservedByMe) {
                 actionButton += `
                    <button onclick="window.app.openConfirmBoughtModal('${gift.id}')" class="w-full mt-3 px-4 py-2 text-white font-bold rounded-lg bg-emerald-600 hover:bg-emerald-700 transition duration-150">
                        –ü—ñ–¥—Ç–≤. –∫—É–ø—ñ–≤–ª—é (Owner)
                    </button>
                `;
            }
            if (isOwner && gift.status === 'RESERVED') {
                actionButton += `
                    <button onclick="window.app.openCancelReservationModal('${gift.id}')" class="w-full mt-2 px-4 py-2 text-gray-700 font-medium rounded-lg bg-gray-200 hover:bg-gray-300 transition duration-150">
                        –°–∫–∞—Å—É–≤–∞—Ç–∏ –±—Ä–æ–Ω—å (Owner)
                    </button>
                `;
            }

            // Decide if the guest should see this card at all
            if (isGuest && gift.status === 'RESERVED' && roomData.hideReserved && !isReservedByMe) {
                return ''; // Hide reserved from non-reserving guests if setting is on
            }

            return `
                <div class="${cardClasses}">
                    <!-- Status Badge -->
                    <div class="absolute top-0 right-0 p-1 rounded-bl-xl rounded-tr-3xl text-xs font-semibold ${statusClass}">
                        ${statusText}
                    </div>

                    <!-- Icon/Avatar -->
                    <div class="w-24 h-24 sm:w-28 sm:h-28 flex items-center justify-center rounded-full text-5xl sm:text-6xl bg-gray-100 mb-4 border-4 border-gray-100 shadow-inner">
                        ${gift.icon}
                    </div>

                    <!-- Name & Price -->
                    <h3 class="text-lg font-bold text-gray-800 line-clamp-2">${gift.name}</h3>
                    <p class="text-sm font-medium text-gray-500 mb-3">‚âà ${gift.price} –≥—Ä–Ω</p>

                    <!-- Details Overlay (Optional, for hover/click) -->
                    <div class="w-full text-sm text-left border-t border-gray-100 pt-3 space-y-1">
                         ${gift.link ? `<a href="${gift.link}" target="_blank" class="block text-teal-600 hover:underline">üîó –ú–∞–≥–∞–∑–∏–Ω</a>` : ''}
                         <p class="text-xs text-gray-500">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${gift.category}</p>
                         <p class="text-xs text-gray-500">–¢–∏–ø: ${gift.type}</p>
                    </div>

                    ${isGuest ? actionButton : ''}
                    ${isOwner ? `<p class="mt-2 text-xs text-rose-500">–í–ª–∞—Å–Ω–∏–∫: ${gift.description || '–ë–µ–∑ –æ–ø–∏—Å—É'}</p>` : ''}
                </div>
            `;
        };

        const renderRoomView = () => {
            if (!roomData) return `<div class="p-8 text-center">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç–∏...</div>`;

            const isOwner = roomData.ownerId === userId;
            const roleText = isOwner ? '–í–ª–∞—Å–Ω–∏–∫' : '–ì—ñ—Å—Ç—å';
            const isGuest = !isOwner;
            const myReservedGifts = roomData.gifts.filter(g => g.reservedBy === userId && g.status === 'RESERVED');
            const otherReservedGifts = roomData.gifts.filter(g => g.reservedBy !== userId && g.status === 'RESERVED');
            const availableGifts = roomData.gifts.filter(g => g.status === 'AVAILABLE');
            const boughtGifts = roomData.gifts.filter(g => g.status === 'BOUGHT');

            // Owner/Guest Switcher
            const roleSwitcher = `
                <div class="flex justify-end mb-4 text-sm text-gray-500">
                    <span class="mr-2">–†–æ–ª—å: ${roleText} (${isOwner ? roomData.ownerName : userName})</span>
                    ${isGuest ? `
                         <a href="#" onclick="window.app.navigate('roomView', { roomId: currentRoomId, role: 'owner' })" class="text-teal-600 hover:underline">
                            (–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –í–ª–∞—Å–Ω–∏–∫–∞)
                        </a>
                    ` : `
                        <a href="#" onclick="window.app.navigate('guestLogin', { roomId: currentRoomId, role: 'guest' })" class="text-teal-600 hover:underline">
                            (–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ì–æ—Å—Ç—è)
                        </a>
                    `}
                </div>
            `;

            return `
                ${renderHeader(roomData.title)}
                <main class="pb-24">
                    ${roleSwitcher}

                    <div class="mb-8 p-4 bg-teal-50 border-l-4 border-teal-600 rounded-lg text-teal-800">
                        <p class="font-semibold">${roomData.description || '–ë–∞–∂–∞–Ω—ñ –ø–æ–¥–∞—Ä—É–Ω–∫–∏ –≤—ñ–¥ –í–ª–∞—Å–Ω–∏–∫–∞.'}</p>
                        <p class="text-sm mt-1">–í—Å—å–æ–≥–æ –≥–æ—Å—Ç–µ–π: ${roomData.guestsCount}. –°—Ç–≤–æ—Ä–µ–Ω–æ ${roomData.ownerName}.</p>
                    </div>

                    <!-- My Reserved Section (Sticky/Prominent for Guest) -->
                    ${myReservedGifts.length > 0 && isGuest ? `
                        <h2 class="text-xl font-bold mt-8 mb-4">‚úÖ –ú–æ—ó –±—Ä–æ–Ω—ñ</h2>
                        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 mb-8" id="my-reserved-list">
                            ${myReservedGifts.map(renderGiftCard).join('')}
                        </div>
                    ` : ''}

                    <!-- Available Gifts -->
                    <h2 class="text-xl font-bold mt-8 mb-4">üéÅ –î–æ—Å—Ç—É–ø–Ω—ñ –ø–æ–¥–∞—Ä—É–Ω–∫–∏ (${availableGifts.length})</h2>
                    <div id="gift-list" class="mb-8">
                        ${availableGifts.map(renderGiftCard).join('')}
                    </div>
                    ${availableGifts.length === 0 ? `<p class="text-gray-500 text-center p-4 bg-white rounded-xl">–ù–∞—Ä–∞–∑—ñ –≤—Å—ñ –ø–æ–¥–∞—Ä—É–Ω–∫–∏ –∑–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω—ñ –∞–±–æ –∫—É–ø–ª–µ–Ω—ñ. üòâ</p>` : ''}


                    <!-- Other Reserved Gifts -->
                    ${otherReservedGifts.length > 0 && (!roomData.hideReserved || isOwner) ? `
                        <h2 class="text-xl font-bold mt-8 mb-4 text-orange-600">‚è≥ –ó–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω—ñ —ñ–Ω—à–∏–º–∏ (${otherReservedGifts.length})</h2>
                        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 opacity-60">
                            ${otherReservedGifts.map(renderGiftCard).join('')}
                        </div>
                    ` : (isGuest && roomData.hideReserved ? `<p class="text-gray-500 text-center p-4 bg-white rounded-xl">–ó–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω—ñ –ø–æ–¥–∞—Ä—É–Ω–∫–∏ –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ –í–ª–∞—Å–Ω–∏–∫–æ–º.</p>` : '')}

                    <!-- Bought Gifts -->
                    ${boughtGifts.length > 0 ? `
                        <h2 class="text-xl font-bold mt-8 mb-4 text-emerald-600">üéâ –ö—É–ø–ª–µ–Ω—ñ –ø–æ–¥–∞—Ä—É–Ω–∫–∏ (${boughtGifts.length})</h2>
                        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 opacity-70">
                            ${boughtGifts.map(renderGiftCard).join('')}
                        </div>
                    ` : ''}

                </main>
                <!-- Sticky Mobile Footer (if Guest) -->
                ${isGuest ? `
                    <div class="fixed bottom-0 left-0 right-0 p-3 bg-white border-t border-gray-200 shadow-2xl sm:hidden">
                        <div class="flex justify-around">
                            <button onclick="window.scrollTo(0, 0)" class="flex flex-col items-center text-xs text-teal-600">
                                <span class="text-lg">üè†</span> –ì–æ–ª–æ–≤–Ω–∞
                            </button>
                            <button onclick="document.getElementById('my-reserved-list') ? document.getElementById('my-reserved-list').scrollIntoView({ behavior: 'smooth' }) : showToast('–£ –≤–∞—Å –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –±—Ä–æ–Ω–µ–π', 'warning')"
                                    class="flex flex-col items-center text-xs text-orange-600">
                                <span class="text-lg">üõí</span> –ú–æ—ó –±—Ä–æ–Ω—ñ (${myReservedGifts.length})
                            </button>
                        </div>
                    </div>
                ` : ''}
            `;
        };

        // --- Modals (Confirmation/Action Popups) ---

        let currentModalGift = null;

        const openModal = (title, content, actions, gift) => {
            currentModalGift = gift;
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div id="action-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 modal-enter-active">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full modal-content-enter-active">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">${title}</h3>
                            <button onclick="window.app.closeModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <div>
                            ${content}
                        </div>
                        <div class="mt-6 space-y-3">
                            ${actions}
                        </div>
                    </div>
                </div>
            `;
            // Trigger animation
            setTimeout(() => {
                const modal = document.getElementById('action-modal');
                modal.classList.add('modal-enter-to');
            }, 10);
        };

        window.app.closeModal = () => {
            const modal = document.getElementById('action-modal');
            if (modal) {
                modal.classList.remove('modal-enter-active');
                modal.classList.add('modal-leave-active');
                modal.addEventListener('transitionend', () => modal.remove());
            }
            currentModalGift = null;
        };

        window.app.openReserveModal = (giftId) => {
            const gift = roomData.gifts.find(g => g.id === giftId);
            if (!gift) return;

            const content = `
                <p class="mb-4 text-gray-700">–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –∑–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏ –ø–æ–¥–∞—Ä—É–Ω–æ–∫:</p>
                <p class="text-lg font-bold text-teal-600">${gift.icon} ${gift.name} (‚âà ${gift.price} –≥—Ä–Ω)?</p>
                <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                    <p class="text-sm font-medium text-gray-600">–í–∞—à–µ —ñ–º'—è –¥–ª—è –±—Ä–æ–Ω—ñ: ${userName}</p>
                </div>
            `;
            const actions = `
                <button onclick="window.app.confirmReserve()" class="w-full px-4 py-3 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700 transition duration-150">
                    –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è
                </button>
                <button onclick="window.app.closeModal()" class="w-full px-4 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
            `;
            openModal('–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –ø–æ–¥–∞—Ä—É–Ω–∫–∞', content, actions, gift);
        };

        window.app.confirmReserve = async () => {
            if (!currentModalGift) return;
            await handleReserveGift(currentModalGift.id);
            window.app.closeModal();
        };

        window.app.openCancelReservationModal = (giftId) => {
            const gift = roomData.gifts.find(g => g.id === giftId);
            if (!gift) return;

            const content = `
                <p class="mb-4 text-gray-700">–í–∏ —Å–∫–∞—Å–æ–≤—É—î—Ç–µ –±—Ä–æ–Ω—å –Ω–∞ –ø–æ–¥–∞—Ä—É–Ω–æ–∫:</p>
                <p class="text-lg font-bold text-orange-600">${gift.icon} ${gift.name} (‚âà ${gift.price} –≥—Ä–Ω)</p>
                <p class="text-sm mt-2">–ü–æ–¥–∞—Ä—É–Ω–æ–∫ –∑–Ω–æ–≤—É —Å—Ç–∞–Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∏–º –¥–ª—è —ñ–Ω—à–∏—Ö –≥–æ—Å—Ç–µ–π.</p>
            `;
            const actions = `
                <button onclick="window.app.confirmCancelReservation()" class="w-full px-4 py-3 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 transition duration-150">
                    –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è –±—Ä–æ–Ω—ñ
                </button>
                <button onclick="window.app.closeModal()" class="w-full px-4 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150">
                    –ó–∞–ª–∏—à–∏—Ç–∏ –±—Ä–æ–Ω—å
                </button>
            `;
            openModal('–°–∫–∞—Å—É–≤–∞–Ω–Ω—è –±—Ä–æ–Ω—ñ', content, actions, gift);
        };

        window.app.confirmCancelReservation = async () => {
            if (!currentModalGift) return;
            await handleCancelReservation(currentModalGift.id);
            window.app.closeModal();
        };

        window.app.openConfirmBoughtModal = (giftId) => {
            const gift = roomData.gifts.find(g => g.id === giftId);
            if (!gift) return;

            const content = `
                <p class="mb-4 text-gray-700">–í–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î—Ç–µ, —â–æ –ø–æ–¥–∞—Ä—É–Ω–æ–∫ –≤–∂–µ –∫—É–ø–ª–µ–Ω–æ:</p>
                <p class="text-xl font-bold text-emerald-600">${gift.icon} ${gift.name}</p>
                <p class="text-sm mt-2">–ü—ñ—Å–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —Ü–µ–π –ø–æ–¥–∞—Ä—É–Ω–æ–∫ –±—É–¥–µ –≤–∏–¥–∞–ª–µ–Ω–æ –∑—ñ —Å–ø–∏—Å–∫—É –¥–æ—Å—Ç—É–ø–Ω–∏—Ö.</p>
            `;
            const actions = `
                <button onclick="window.app.confirmBought()" class="w-full px-4 py-3 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition duration-150">
                    –ü–æ–∑–Ω–∞—á–∏—Ç–∏ —è–∫ "–ö—É–ø–ª–µ–Ω–æ"
                </button>
                <button onclick="window.app.closeModal()" class="w-full px-4 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
            `;
            openModal('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–æ–∫—É–ø–∫–∏', content, actions, gift);
        };

        window.app.confirmBought = async () => {
            if (!currentModalGift) return;
            await handleConfirmBought(currentModalGift.id);
            window.app.closeModal();
        };

        // --- Main Render Function ---

        const renderApp = () => {
            const appDiv = document.getElementById('app');
            let htmlContent = '';

            // Stop listener if not in a room view
            if (currentView !== 'roomView' && currentView !== 'roomLink' && currentView !== 'guestLogin' && unsubscribeRoomListener) {
                unsubscribeRoomListener();
                unsubscribeRoomListener = null;
                roomData = null;
            }

            // Start listener if we just entered a room view
            if ((currentView === 'roomView' || currentView === 'roomLink') && currentRoomId && !roomData) {
                 // Initial load, start listener
                startRoomListener(currentRoomId);
            }

            switch (currentView) {
                case 'landing':
                    htmlContent = renderLanding();
                    break;
                case 'createRoom':
                case 'addGifts':
                    htmlContent = renderCreateRoom();
                    break;
                case 'roomLink':
                    htmlContent = renderRoomLink();
                    break;
                case 'guestLogin':
                    htmlContent = renderGuestLogin();
                    break;
                case 'roomView':
                    if (roomData) {
                        htmlContent = renderRoomView();
                    } else if (currentRoomId) {
                         // Fallback while data loads (already starting listener)
                         htmlContent = `<div class="p-8 text-center text-gray-500">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç–∏: ${currentRoomId}...</div>`;
                    } else {
                        // Should not happen
                        htmlContent = renderLanding();
                    }
                    break;
                default:
                    htmlContent = renderLanding();
                    break;
            }

            appDiv.innerHTML = htmlContent;
        };

        // --- Initialization on Window Load ---

        window.onload = async () => {
            // –ü—Ä–∏–∫—Ä—ñ–ø–ª—é—î–º–æ –≤—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–±'—î–∫—Ç–∞ –ø–µ—Ä–µ–¥ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—î—é
            window.app = {
                navigate,
                handleJoinRoom: window.app.handleJoinRoom,
                startAddingGifts: window.app.startAddingGifts,
                updateDraftGift: window.app.updateDraftGift,
                finalizeRoomCreation: window.app.finalizeRoomCreation,
                copyLink: window.app.copyLink,
                viewRoomAsOwner: window.app.viewRoomAsOwner,
                loginAsGuest: window.app.loginAsGuest,
                openReserveModal: window.app.openReserveModal,
                confirmReserve: window.app.confirmReserve,
                openCancelReservationModal: window.app.openCancelReservationModal,
                confirmCancelReservation: window.app.confirmCancelReservation,
                openConfirmBoughtModal: window.app.openConfirmBoughtModal,
                confirmBought: window.app.confirmBought,
                closeModal: window.app.closeModal,
            };
            
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase —Ç–∞ –æ–±—Ä–æ–±–∫–∞ URL
            await initFirebase();
            handleInitialRoute();
        };

    </script>
</body>
</html>

